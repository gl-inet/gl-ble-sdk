/*****************************************************************************
 * @file 
 * @brief 
 *******************************************************************************
 Copyright 2022 GL-iNet. https://www.gl-inet.com/

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at
 
 http://www.apache.org/licenses/LICENSE-2.0
 
 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
 ******************************************************************************/

#ifndef SLI_BT_GATT_DEF_H
#define SLI_BT_GATT_DEF_H

#include <stddef.h>
#include <stdint.h>

typedef struct {
  uint16_t len;  //size of buffer
  uint8_t data[];
} sli_bt_gattdb_value_t;

typedef struct {
  uint8_t properties;   //Characteristic properties, same as in characteristic descriptor gatt_char_prop
  uint16_t max_len;  //Maximum length of data in buffer
  uint16_t len;  //current size of data in buffer
  uint8_t data[];  //size is max_len
} sli_bt_gattdb_attribute_chrvalue_t;

typedef struct {
  uint8_t flags;   //client characteristic flags allowed 1-notification, 2-indication)
  uint8_t clientconfig_index;   // index to client config.
} sli_bt_gattdb_attribute_config_t;

typedef struct {
  uint8_t properties;   //Characteristic properties, same as in characteristic descriptor gatt_char_prop
  uint16_t char_uuid;   // characteristic UUID handle
} sli_bt_gattdb_attribute_characteristic_t;

typedef struct {
  uint16_t start;    //Included Service Attribute Handle
  uint16_t end;    //End Group Handle
} sli_bt_gattdb_attribute_service_include_t;

typedef struct {
  uint16_t handle;
  uint16_t uuid;
  uint16_t permissions;   //gatt_attribute_permission
  uint16_t caps;   // Capability bit flags
  uint8_t datatype;   //Just use uint8_t Do not use enum type, may cause compatibility troubles
  uint8_t state;
  union {
    const sli_bt_gattdb_value_t *constdata;     //generic constant data
    sli_bt_gattdb_attribute_chrvalue_t *dynamicdata;     //Modifiable data
    sli_bt_gattdb_attribute_config_t configdata;
    sli_bt_gattdb_attribute_characteristic_t characteristic;
    sli_bt_gattdb_attribute_service_include_t service_include;
  };
} sli_bt_gattdb_attribute_t;

struct sli_bt_gattdb_s {
  const sli_bt_gattdb_attribute_t  *attributes;
  uint16_t                          attribute_table_size;
  uint16_t                          attribute_num;
  const uint16_t                   *uuid16;
  uint16_t                          uuid16_table_size;
  uint16_t                          uuid16_num;
  const uint8_t                    *uuid128;
  uint16_t                          uuid128_table_size;
  uint16_t                          uuid128_num;
  uint8_t                           num_ccfg;
  uint16_t                          caps_mask;
  uint16_t                          enabled_caps;
};

typedef struct sli_bt_gattdb_s sli_bt_gattdb_t;

extern const sli_bt_gattdb_t *static_gattdb;

/**
 * @addtogroup dynamic_gatt_config
 *
 * Dynamic GATT database configuration.
 */

/**
 * Flag indicating GATT caching should be enabled. When enabled, a Generic
 * Attribute Profile Service will be created in database if one doesn't exist.
 **/
#define SLI_BT_GATTDB_CONFIG_FLAG_ENABLE_GATT_CACHING    (0x01)

/**
 * Flag indicating the static database should be included if one exists.
 */
#define SLI_BT_GATTDB_CONFIG_FLAG_INCLUDE_STATIC_DB      (0X02)

typedef struct {
  uint32_t flags;
} sli_bt_gattdb_config_t;

/** @} (end addtogroup dynamic_gatt_config) */

#endif
